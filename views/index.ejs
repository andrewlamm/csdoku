<!DOCTYPE html>
<html>
  <%- include('partials/helmet.ejs', {title: 'csgodoku'}) %>
  <body>
    <div class="w-full min-h-screen flex flex-col justify-center items-center bg-black">
      <div class="flex flex-row justify-center">
        <div class="flex flex-col">
          <div class="flex flex-row">
            <div class="h-36 w-36"></div>
            <% for (let i = 0; i < 3; i++) { %>
              <%- displayClue(puzzle[i]) %>
            <% } %>
          </div>
          <div class="flex flex-row">
            <div class="flex flex-col">
              <% for (let i = 3; i < 6; i++) { %>
                <%- displayClue(puzzle[i]) %>
              <% } %>
            </div>
            <div class="grid grid-cols-3 rounded-2xl border overflow-hidden">
              <% for (let i = 0; i < 9; i++) { %>
                <div class="flex flex-col h-36 w-36 items-center justify-center border-white <%= getBorders(i) %> cursor-pointer bg-slate-800 hover:bg-slate-600 transition-colors" onclick="openPopup(<%= i %>)">
                </div>
              <% } %>
            </div>
          </div>
        </div>
        <div class="flex flex-col justify-center items-center text-2xl ml-6 text-white pt-36">
          <div>
            you have
          </div>
          <div class="text-6xl font-bold" id="rounds-left">
            9
          </div>
          <div>
            round<span id="rounds-plural">s</span> left
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col justify-center items-center absolute z-0 top-0 w-full min-h-screen hidden" id="player-popup-bg" >
      <div class="flex flex-col items-center justify-center p-4 w-96 z-10 bg-gray-400 rounded-xl" id="player-popup">
        <div class="text-center mb-4" id="player-popup-text">
          enter a player who <span class="font-bold" id="player-popup-clue-1"></span> and <span class="font-bold" id="player-popup-clue-2"></span>
        </div>
        <div class="w-80">
          <input type="text" placeholder="enter a player" class="w-80 px-2 py-1.5 rounded-lg" oninput="updatePlayerList()" id="player-popup-input">
        </div>
        <div class="w-80 max-h-128 overflow-y-auto my-2" id="player-popup-list">

        </div>
        <div class="mt-4 w-80">
          <div class="rounded-lg bg-blue-500 w-full text-center py-2 font-bold cursor-pointer" onclick="closePopup()">
            close
          </div>
        </div>
      </div>
    </div>
    <script>
      const puzzle = <%- JSON.stringify(puzzle) %>
      const PUZZLES_GRID = [[0, 3], [1, 3], [2, 3], [0, 4], [1, 4], [2, 4], [0, 5], [1, 5], [2, 5]]

      let popupShowing = false
      function convertClueToText(clue) {
        if (clue[0] === 'team') {
          return `has played for ${clue[1]}`
        }
        else if (clue[0] === 'country') {
          return `is from ${clue[1]}`
        }
        else if (clue[0] === 'ratingYear') {
          return `had over a rating 2.0 of ${clue[1][1]} in ${clue[1][0]}`
        }
        else if (clue[0] === 'topPlacement') {
          return `has been in the top ${clue[1]} players in year`
        }
        else {
          return `has over ${clue[1]} ${clue[0]}`
        }
      }

      function closePopup() {
        popupShowing = false
        document.getElementById('player-popup-bg').classList.add('hidden')
        document.getElementById('player-popup-input').value = ''
        updatePlayerList()
      }
      function openPopup(ind) {
        document.getElementById('player-popup-clue-1').innerHTML = convertClueToText(puzzle[PUZZLES_GRID[ind][0]])
        document.getElementById('player-popup-clue-2').innerHTML = convertClueToText(puzzle[PUZZLES_GRID[ind][1]])

        popupShowing = true
        document.getElementById('player-popup-bg').classList.remove('hidden')
      }

      // window.addEventListener('click', function(e) {
      //   if (popupShowing && !document.getElementById('player-popup').contains(e.target)) {
      //     closePopup()
      //   }
      // })

      function updatePlayerList() {
        const val = document.getElementById('player-popup-input').value.toLowerCase()
        document.getElementById('player-popup-list').innerHTML = ''

        if (val.length === 0) {
          return
        }
        else {
          filtered_players = players.filter(player => {
            if (player.name.toLowerCase().startsWith(val)) {
              return true
            }

            const names = player.fullName.split(' ')
            for (let i = 0; i < names.length; i++) {
              if (names[i].toLowerCase().startsWith(val)) {
                return true
              }
            }

            return false
          })

          filtered_players.map(player => {
            playerNameElement = document.createElement('div')
            playerNameElement.innerHTML = player.name
            playerNameElement.classList.add('font-bold', 'text-lg')

            playerFullNameElement = document.createElement('div')
            playerFullNameElement.innerHTML = player.fullName
            playerFullNameElement.classList.add('text-sm')

            playerElement = document.createElement('div')
            playerElement.classList.add('flex', 'flex-col', 'justify-center', 'flex-grow')
            playerElement.appendChild(playerNameElement)
            playerElement.appendChild(playerFullNameElement)

            selectElement = document.createElement('div')
            selectElement.classList.add('rounded-lg', 'bg-blue-400', 'px-2', 'py-1', 'cursor-pointer', 'mr-2')
            selectElement.innerHTML = 'select'

            playerElementWrapper = document.createElement('div')
            playerElementWrapper.classList.add('flex', 'flex-row', 'items-center', 'w-full', 'my-4')
            playerElementWrapper.appendChild(playerElement)
            playerElementWrapper.appendChild(selectElement)

            document.getElementById('player-popup-list').appendChild(playerElementWrapper)

            // document.getElementById('player-popup-list').innerHTML += `
            //   <div class="flex flex-row items-center w-full my-4">
            //     <div class="flex flex-col justify-center">
            //       <div>
            //         ${player.name}
            //       </div>
            //       <div>
            //         ${player.fullName}
            //       </div>
            //     </div>
            //     <div>
            //       <div class="rounded-lg bg-gray-400">
            //         select
            //       </div>
            //     </div>
            //   </div>
            // `
          })

          return
        }
      }

      const players = <%- JSON.stringify(players) %>
      for (let i = 0; i < players.length; i++) {
        players[i].guessed = false
        players[i].correct = false
      }
    </script>
  </body>
</html>
